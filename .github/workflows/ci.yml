name: ğŸ§ª SkillWise CI Pipeline

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]
    
env:
  NODE_VERSION: '18'
  
jobs:
  # ======================================
  # ğŸ” CODE QUALITY & LINTING
  # ======================================
  lint:
    name: ğŸ” Code Quality & Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¥ Install Dependencies
        run: |
          npm ci
          cd backend && npm ci
          cd ../frontend && npm ci
          
      - name: ğŸ” Run Backend Linting
        run: |
          cd backend
          npm run lint
          
      - name: ğŸ” Run Frontend Linting  
        run: |
          cd frontend
          npm run lint
        continue-on-error: true # Frontend may not have linting yet
        
      - name: âœ… Linting Complete
        run: echo "âœ… Code quality checks passed!"

  # ======================================
  # ğŸ§ª UNIT TESTS (JEST)
  # ======================================
  unit-tests:
    name: ğŸ§ª Unit Tests (Jest)
    runs-on: ubuntu-latest
    needs: lint
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: skillwise_test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
    steps:
      - name: ğŸ“ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js  
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¥ Install Dependencies
        run: |
          npm ci
          cd backend && npm ci
          
      - name: ğŸ—„ï¸ Setup Test Database
        run: |
          cd backend
          cp .env.example .env.test || echo "No .env.example found, creating basic .env.test"
          cat > .env.test << EOF
          NODE_ENV=test
          PORT=3001
          DATABASE_URL=postgres://test:test@localhost:5432/skillwise_test
          JWT_SECRET=test-secret-key-for-ci
          JWT_REFRESH_SECRET=test-refresh-secret-key-for-ci
          OPENAI_API_KEY=test-key
          EOF
          
      - name: ğŸ—„ï¸ Run Database Migrations
        run: |
          cd backend
          npm run migrate
        env:
          NODE_ENV: test
          DATABASE_URL: postgres://test:test@localhost:5432/skillwise_test
          
      - name: ğŸ§ª Run Unit Tests
        run: |
          cd backend
          npm test -- --verbose --coverage
        env:
          NODE_ENV: test
          DATABASE_URL: postgres://test:test@localhost:5432/skillwise_test
          JWT_SECRET: test-secret-key-for-ci
          JWT_REFRESH_SECRET: test-refresh-secret-key-for-ci
          
      - name: ğŸ“Š Upload Coverage Reports
        uses: codecov/codecov-action@v3
        with:
          directory: ./backend/coverage
          flags: backend
          fail_ci_if_error: false
          
      - name: âœ… Unit Tests Complete
        run: echo "âœ… All unit tests passed! ğŸ‰"

  # ======================================  
  # ğŸš€ E2E TESTS (CYPRESS)
  # ======================================
  e2e-tests:
    name: ğŸš€ E2E Tests (Cypress)
    runs-on: ubuntu-latest
    needs: [lint, unit-tests]
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: skillwise_e2e
          POSTGRES_USER: test  
          POSTGRES_PASSWORD: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
    steps:
      - name: ğŸ“ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¥ Install Dependencies
        run: |
          npm ci
          cd backend && npm ci
          cd ../frontend && npm ci
          
      - name: ğŸ—„ï¸ Setup E2E Database
        run: |
          cd backend
          cat > .env.e2e << EOF
          NODE_ENV=test
          PORT=3001
          DATABASE_URL=postgres://test:test@localhost:5432/skillwise_e2e
          JWT_SECRET=test-secret-key-for-e2e
          JWT_REFRESH_SECRET=test-refresh-secret-key-for-e2e
          OPENAI_API_KEY=test-key
          EOF
          
      - name: ğŸ—„ï¸ Run E2E Database Migrations
        run: |
          cd backend  
          npm run migrate
        env:
          NODE_ENV: test
          DATABASE_URL: postgres://test:test@localhost:5432/skillwise_e2e
          
      - name: ğŸ—„ï¸ Seed Test Data
        run: |
          cd backend
          npm run seed
        env:
          NODE_ENV: test
          DATABASE_URL: postgres://test:test@localhost:5432/skillwise_e2e
          
      - name: ğŸš€ Start Backend Server
        run: |
          cd backend
          npm start &
          sleep 10 # Give server time to start
        env:
          NODE_ENV: test
          PORT: 3001
          DATABASE_URL: postgres://test:test@localhost:5432/skillwise_e2e
          JWT_SECRET: test-secret-key-for-e2e
          JWT_REFRESH_SECRET: test-refresh-secret-key-for-e2e
        
      - name: ğŸš€ Start Frontend Server  
        run: |
          cd frontend
          npm start &
          sleep 15 # Give React time to build and start
        env:
          REACT_APP_API_URL: http://localhost:3001
          CI: false # Treat warnings as warnings, not errors
          
      - name: ğŸ§ª Run Cypress E2E Tests
        uses: cypress-io/github-action@v6
        with:
          working-directory: ./
          wait-on: 'http://localhost:3000, http://localhost:3001/health'
          wait-on-timeout: 120
          browser: chrome
          headless: true
        env:
          CYPRESS_BASE_URL: http://localhost:3000
          CYPRESS_API_URL: http://localhost:3001
          
      - name: ğŸ“¸ Upload Cypress Screenshots  
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-screenshots
          path: cypress/screenshots
          
      - name: ğŸ¥ Upload Cypress Videos
        uses: actions/upload-artifact@v4
        if: failure()  
        with:
          name: cypress-videos
          path: cypress/videos
          
      - name: âœ… E2E Tests Complete
        run: echo "âœ… All E2E tests passed! ğŸ‰"

  # ======================================
  # ğŸŠ SUCCESS SUMMARY
  # ======================================  
  ci-success:
    name: ğŸŠ CI Pipeline Success
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, e2e-tests]
    if: success()
    
    steps:
      - name: ğŸ‰ All Checks Passed!
        run: |
          echo "ğŸŠ SkillWise CI Pipeline Complete!"
          echo "âœ… Code Quality: PASSED"  
          echo "âœ… Unit Tests: PASSED"
          echo "âœ… E2E Tests: PASSED"
          echo ""
          echo "ğŸš€ Ready for merge! This PR maintains SkillWise quality standards."
          
  # ======================================
  # ğŸš¨ FAILURE NOTIFICATION  
  # ======================================
  ci-failure:
    name: ğŸš¨ CI Pipeline Failed
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, e2e-tests]
    if: failure()
    
    steps:
      - name: ğŸš¨ Pipeline Failed
        run: |
          echo "ğŸš¨ SkillWise CI Pipeline Failed!"
          echo "âŒ One or more checks failed"
          echo ""
          echo "Please check the logs above and fix the issues before merging."
          echo "Quality gates must pass to maintain SkillWise standards."
          exit 1